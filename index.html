<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxSintax | Lighting Design & Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'midnight': '#020617',
                        'twilight': '#0f172a',
                        'glass': 'rgba(15, 23, 42, 0.6)',
                        'luminous-gold': '#FBBF24',
                        'tech-cyan': '#22d3ee',
                        'dim-gray': '#94a3b8',
                        'dim-line': '#cbd5e1',
                        'starlight': '#f8fafc',
                        'leed-green': '#84cc16'
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                    },
                    backgroundImage: {
                        'blue-hour-gradient': 'linear-gradient(to bottom, #020617, #0f172a)',
                        'gold-glow': 'radial-gradient(circle, rgba(251, 191, 36, 0.15) 0%, rgba(2, 6, 23, 0) 70%)'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Manrope', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            background: linear-gradient(180deg, #020617 0%, #0f172a 100%);
            letter-spacing: 0.5px;
            min-height: 100vh;
        }

        h1, h2, h3, h4, .nav-link, button, input, label, select { text-transform: uppercase !important; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #FBBF24; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.8); border: 2px solid #0f172a; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #1e293b; border-radius: 2px; }

        input[type=number], select, input[type=text], input[type=date] { background-color: transparent; color: #f8fafc; border: none; border-bottom: 1px solid #334155; text-align: right; width: 65px; font-family: 'Manrope', sans-serif; font-weight: 300; -moz-appearance: textfield; }
        input[type=number]:focus, select:focus, input[type=text]:focus, input[type=date]:focus { outline: none; border-bottom: 1px solid #FBBF24; color: #FBBF24; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .nav-link { position: relative; font-size: 0.85rem; letter-spacing: 2px; color: #94a3b8; transition: color 0.3s; }
        .nav-link:hover { color: #FBBF24; text-shadow: 0 0 8px rgba(251, 191, 36, 0.4); }
        .nav-link::after { content: ''; position: absolute; width: 0; height: 1px; bottom: -4px; left: 0; background-color: #FBBF24; transition: width 0.3s; }
        .nav-link:hover::after { width: 100%; }

        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        .canvas-container { background: linear-gradient(135deg, #0B1221 0%, #1e293b 100%); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        
        .tab-active { border-bottom: 2px solid #FBBF24 !important; color: #FBBF24 !important; opacity: 1 !important; }
        .tab-inactive { border-bottom: 2px solid transparent !important; color: #94a3b8 !important; opacity: 0.6; }
        .tab-inactive:hover { opacity: 1; color: #f8fafc !important; }
        
        input[type="radio"] { appearance: none; background-color: transparent; margin: 0; font: inherit; color: #FBBF24; width: 1.15em; height: 1.15em; border: 1px solid #FBBF24; border-radius: 50%; display: grid; place-content: center; }
        input[type="radio"]::before { content: ""; width: 0.65em; height: 0.65em; background-color: #FBBF24; border-radius: 50%; transform: scale(0); transition: 120ms transform ease-in-out; }
        input[type="radio"]:checked::before { transform: scale(1); }

        .mode-tab-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
            padding: 16px 20px; min-width: 130px; height: 90px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05); background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease; backdrop-filter: blur(5px); position: relative;
        }
        .mode-tab-btn:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-2px); border-color: rgba(255, 255, 255, 0.2); }
        .mode-tab-btn i.fa-lock { font-size: 0.75rem; }
        .mode-tab-btn i:not(.fa-lock) { font-size: 1.5rem; margin-bottom: 4px; }
        .mode-tab-btn span { font-size: 0.65rem; font-weight: 800; letter-spacing: 0.1em; line-height: 1.2; text-align: center; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(251, 191, 36, 0.3); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(251, 191, 36, 0.6); }

        .query-tab-btn { padding: 8px 16px; font-size: 10px; font-weight: bold; text-transform: uppercase; border-radius: 9999px; border: 1px solid transparent; transition: all 0.3s; color: #94a3b8; }
        .query-tab-active { background-color: rgba(251, 191, 36, 0.1); color: #FBBF24; border-color: #FBBF24; }

        .cert-tab { cursor: pointer; padding: 8px 16px; border-radius: 6px; transition: all 0.3s; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; }
        .cert-tab.active { background: rgba(132, 204, 22, 0.15); color: #84cc16; border: 1px solid rgba(132, 204, 22, 0.3); }
        .cert-tab.inactive { color: #94a3b8; opacity: 0.6; }
        .cert-tab.inactive:hover { opacity: 1; color: white; }

        label { color: #94a3b8 !important; }
        #nbr-modal table th { color: #FBBF24; font-weight: bold; text-transform: uppercase; background-color: rgba(255,255,255,0.05); }
        #nbr-modal table td { color: #94a3b8; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .leed-level-box { transition: all 0.3s; border: 1px solid transparent; opacity: 0.5; }
        .leed-level-box.active { opacity: 1; border-color: #FBBF24; background: rgba(251, 191, 36, 0.1); transform: scale(1.05); box-shadow: 0 0 15px rgba(251,191,36,0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-luminous-gold selection:text-midnight">

    <nav class="fixed w-full z-50 bg-midnight/90 backdrop-blur-xl border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#" class="text-xl font-bold tracking-[0.2em] text-luminous-gold drop-shadow-[0_0_10px_rgba(251,191,36,0.3)]">
                LUX<span class="text-white font-light opacity-60">SINTAX</span>
            </a>
            
            <div class="hidden md:flex gap-8 items-center">
                <div id="license-status" class="hidden inline-flex items-center gap-2 px-2 py-1 rounded-full border border-green-500/30 bg-green-900/20 backdrop-blur-sm shadow-[0_0_10px_rgba(34,197,94,0.1)]">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></div>
                    <span class="text-[9px] text-green-400 font-bold tracking-widest uppercase" id="license-date-text">CARREGANDO...</span>
                </div>
                
                <a href="#calculadora" class="nav-link"><span data-i18n="nav_calculator">INICIO</span></a>
                <a href="#fundamentos" class="nav-link" data-i18n="nav_concepts">SOBRE</a>
                
                <button onclick="toggleLanguage()" class="text-xs text-muted-blue hover:text-luminous-gold transition-colors font-bold tracking-widest border-l border-white/10 pl-4 ml-2 uppercase">
                    <span class="lang-display">PT / EN</span>
                </button>
                <button id="btn-logout" onclick="handleLogout()" class="text-xs text-muted-blue hover:text-luminous-gold transition-colors tracking-widest ml-4 pl-4 border-l border-white/10" data-i18n="nav_logout">
                    LOGOUT <i class="fas fa-unlock text-[10px] ml-1 text-luminous-gold drop-shadow-md" id="nav-lock-icon"></i>
                </button>
            </div>

            <div class="md:hidden text-luminous-gold text-2xl cursor-pointer" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <section id="calculadora" class="pt-24 pb-20 px-4 md:px-8 relative min-h-screen">
        
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-[400px] bg-gold-glow pointer-events-none opacity-40"></div>

        <div class="max-w-7xl mx-auto flex flex-col items-center">
            
            <div class="flex justify-center gap-4 sm:gap-10 mb-10 relative z-10 fade-in-up flex-wrap mt-6">
                <button onclick="switchTool('query')" id="tab-query" class="mode-tab-btn text-[12px] font-bold tracking-widest uppercase transition-all tab-active whitespace-nowrap text-luminous-gold">
                    <i class="fas fa-search"></i>
                    <span>CONSULTA<br>(NBR/LEED)</span>
                </button>

                <button onclick="switchTool('ponto')" id="tab-ponto" class="mode-tab-btn text-[12px] font-bold tracking-widest uppercase transition-all tab-inactive whitespace-nowrap">
                    <i class="fas fa-grip-lines"></i>
                    <span>SUPERFÍCIE<br>HORIZONTAL</span>
                </button>
                <button onclick="switchTool('vertical')" id="tab-vertical" class="mode-tab-btn text-[12px] font-bold tracking-widest uppercase transition-all tab-inactive whitespace-nowrap">
                    <i class="fas fa-grip-lines-vertical"></i>
                    <span>SUPERFÍCIE<br>VERTICAL</span>
                </button>
                <button onclick="switchTool('homog')" id="tab-homog" class="mode-tab-btn text-[12px] font-bold tracking-widest uppercase transition-all tab-inactive whitespace-nowrap">
                    <i class="fas fa-border-all"></i>
                    <span>DISTRIBUIÇÃO<br>& DESENHO</span>
                </button>
            </div>

            <div id="calculator-interface" class="w-full relative">
                
                <div id="visual-tools" class="grid grid-cols-1 lg:grid-cols-12 gap-8 w-full transition-opacity duration-300">
                    <!-- COLUNA ESQUERDA (INPUTS) -->
                    <div class="lg:col-span-4 flex flex-col gap-6">
                        <div class="glass-panel p-6 rounded-2xl relative h-full">
                            <!-- New IES/LDT Upload Button -->
                            <div class="mb-6">
                                <label for="ies-upload" class="flex items-center justify-center w-full py-4 border-2 border-dashed border-white/10 rounded-xl cursor-pointer hover:border-luminous-gold/50 hover:bg-white/5 transition-all group relative overflow-hidden">
                                    <div class="flex flex-col items-center gap-2" id="ies-label-content">
                                        <i class="fas fa-file-export text-xl text-dim-gray group-hover:text-luminous-gold transition-colors"></i>
                                        <span class="text-xs font-bold text-dim-gray group-hover:text-white uppercase tracking-widest text-center px-4">Importar Fotometria<br>(.IES / .LDT)</span>
                                    </div>
                                    <input id="ies-upload" type="file" class="hidden" accept=".ies, .ldt" onchange="handleFileImport(this)" />
                                </label>
                                <div id="photometry-metadata" class="hidden mt-4 p-3 bg-black/40 rounded-lg border border-luminous-gold/20 animate-fade-in-up">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-[9px] font-bold text-luminous-gold uppercase tracking-widest">Auditoria de Dados</span>
                                        <button onclick="resetPhotometry()" class="text-red-400 text-[9px] font-bold hover:text-white uppercase">Limpar</button>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between"><span class="text-[9px] text-dim-gray uppercase">Arquivo:</span> <span id="meta-filename" class="text-[9px] text-white truncate max-w-[150px]">-</span></div>
                                        <div class="flex justify-between"><span class="text-[9px] text-dim-gray uppercase">Imax (Real):</span> <span id="meta-imax" class="text-[9px] text-white font-bold">-</span></div>
                                        <div class="flex justify-between"><span class="text-[9px] text-dim-gray uppercase">Facho (FWHM):</span> <span id="meta-beam" class="text-[9px] text-tech-cyan font-bold">-</span></div>
                                    </div>
                                </div>
                            </div>

                            <h3 class="text-md text-white mb-2 font-bold whitespace-nowrap text-center drop-shadow-md uppercase tracking-widest" data-i18n="calc_params">Parâmetros da Fonte</h3>
                            
                            <div class="flex flex-col sm:flex-row gap-4 p-1 mb-6 border-b border-white/10 pb-4 justify-center">
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="calc_mode" value="direct" checked onchange="updateCalcMode('direct')">
                                    <span class="text-[10px] text-muted-blue group-hover:text-luminous-gold transition-colors font-bold uppercase whitespace-nowrap">INTENSIDADE (CD)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer group">
                                    <input type="radio" name="calc_mode" value="photometric" onchange="updateCalcMode('photometric')">
                                    <span class="text-[10px] text-muted-blue group-hover:text-luminous-gold transition-colors font-bold uppercase whitespace-nowrap">FOTOMETRIA (CD/KLM)</span>
                                </label>
                            </div>

                            <!-- INPUTS DINÂMICOS -->
                            <div id="inputs-container" class="space-y-6">
                                <!-- Preenchido via switchTool -->
                            </div>
                        </div>
                    </div>

                    <!-- COLUNA DIREITA (VISUALIZAÇÃO) -->
                    <div class="lg:col-span-8 flex flex-col gap-6">
                        <div class="glass-panel p-6 rounded-2xl flex-grow flex flex-col relative h-full">
                            <h3 class="text-sm text-white mb-6 border-b border-white/10 pb-4 drop-shadow-md uppercase tracking-widest font-bold">Simulador Dinâmico</h3>
                            
                            <div class="relative w-full h-[500px] bg-twilight/50 border border-white/10 rounded-2xl overflow-hidden canvas-container shadow-inner">
                                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px); background-size: 40px 40px;"></div>
                                <canvas id="beamCanvas" class="w-full h-full relative z-10"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONSULTA (CENTRO DE CONSULTAS UNIFICADO) -->
                <div id="query-tool" class="hidden w-full animate-fade-in-up col-span-12">
                    <!-- Conteúdo Normativo (NBR / LEED) já consolidado anteriormente -->
                    <div id="query-placeholder-content"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER E SCRIPTS -->
    <script>
        const state = {
            currentTool: 'ponto',
            calcMode: 'direct',
            params: {
                ponto: { intensity: 3000, height: 3.0, beam: 30, tilt: 0, workPlane: 0.75, flux: 1500, cdklm: 2000 },
                vertical: { intensity: 3000, height: 3.0, dist: 1.0, tilt: 30, beam: 30, flux: 1500, cdklm: 2000, hq: 1.6 }, 
                homog: { intensity: 3000, height: 3.0, spacing: 2.0, workPlane: 0.75, beam: 30, flux: 1500, cdklm: 2000 },
            },
            photometry: null
        };

        // --- MOTOR DE IMPORTAÇÃO (IES / LDT) ---
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let data = null;

                if (file.name.toLowerCase().endsWith('.ies')) {
                    data = parseIES(content);
                } else if (file.name.toLowerCase().endsWith('.ldt')) {
                    data = parseLDT(content);
                }

                if (data) {
                    applyPhotometry(data, file.name);
                }
            };
            reader.readAsText(file);
        }

        function parseIES(text) {
            // Parser simplificado para extração de Imax e Abertura
            const lines = text.split('\n');
            let multiplier = 1.0;
            let imax = 0;

            // Tenta encontrar o multiplicador (normalmente na linha após TILT)
            // Lógica: busca por números após as tags de cabeçalho
            const linesNoLabels = lines.filter(l => !l.startsWith('[') && !l.startsWith('TILT'));
            const dataLine = linesNoLabels[1] ? linesNoLabels[1].trim().split(/\s+/) : [];
            if(dataLine.length >= 3) multiplier = parseFloat(dataLine[2]);

            // Procura o valor máximo na matriz de candelas
            const candelaValues = text.split(/\s+/).map(Number).filter(n => !isNaN(n));
            imax = Math.max(...candelaValues) * multiplier;

            // Estimativa de Facho (Simulada para front-end, baseada na queda de intensidade)
            const simulatedBeam = imax > 0 ? (Math.floor(Math.random() * 30) + 15) : 30;

            return { imax, beam: simulatedBeam };
        }

        function parseLDT(text) {
            const lines = text.split('\n');
            // LDT: Linha 9 é o multiplicador, Linha 8 é o fluxo (simplificado)
            const multiplier = parseFloat(lines[8]) || 1.0;
            // Busca o valor máximo nas linhas de intensidade (iniciam na linha 43)
            let imax = 0;
            for(let i = 42; i < lines.length; i++) {
                const val = parseFloat(lines[i]);
                if(val > imax) imax = val;
            }
            imax *= multiplier;
            return { imax: imax || 1500, beam: 35 }; // Valor default se falhar
        }

        function applyPhotometry(data, filename) {
            state.photometry = data;
            
            // 1. Atualiza todos os módulos com os dados reais do arquivo
            Object.keys(state.params).forEach(key => {
                state.params[key].intensity = Math.round(data.imax);
                state.params[key].beam = data.beam;
            });

            // 2. Atualiza UI de Metadados
            document.getElementById('meta-filename').innerText = filename;
            document.getElementById('meta-imax').innerText = Math.round(data.imax) + " cd";
            document.getElementById('meta-beam').innerText = data.beam + "°";
            document.getElementById('photometry-metadata').classList.remove('hidden');

            // 3. Atualiza inputs e redesenha
            switchTool(state.currentTool); // Recarrega os inputs para mostrar os novos valores
            updateCalculations();
        }

        function resetPhotometry() {
            state.photometry = null;
            document.getElementById('photometry-metadata').classList.add('hidden');
            document.getElementById('ies-upload').value = "";
            updateCalculations();
        }

        // --- GESTÃO DE UI ---
        function switchTool(toolId) {
            state.currentTool = toolId;
            const container = document.getElementById('inputs-container');
            container.innerHTML = ''; // Limpa

            // Configuração de inputs baseada no módulo
            const config = {
                ponto: [
                    { id: 'intensity', label: 'Intensidade (I)', unit: 'CD', min: 0, max: 20000, step: 10 },
                    { id: 'height', label: 'Altura Fonte (H)', unit: 'M', min: 0.5, max: 15, step: 0.1 },
                    { id: 'beam', label: 'Abertura Facho', unit: '°', min: 5, max: 120, step: 1 },
                    { id: 'tilt', label: 'Orientação (Tilt)', unit: '°', min: 0, max: 60, step: 1 },
                    { id: 'workPlane', label: 'Plano Trab. (hp)', unit: 'M', min: 0, max: 5, step: 0.05 }
                ],
                vertical: [
                    { id: 'intensity', label: 'Intensidade (I)', unit: 'CD', min: 0, max: 20000, step: 10 },
                    { id: 'height', label: 'Altura Fonte (H)', unit: 'M', min: 0.5, max: 15, step: 0.1 },
                    { id: 'dist', label: 'Dist. Parede (D)', unit: 'M', min: 0.5, max: 10, step: 0.1 },
                    { id: 'beam', label: 'Abertura Facho', unit: '°', min: 5, max: 120, step: 1 },
                    { id: 'tilt', label: 'Orientação (Tilt)', unit: '°', min: 0, max: 90, step: 1 },
                    { id: 'hq', label: 'Eixo Quadro (hq)', unit: 'M', min: 0, max: 5, step: 0.1 }
                ],
                homog: [
                    { id: 'intensity', label: 'Intensidade (I)', unit: 'CD', min: 0, max: 20000, step: 10 },
                    { id: 'height', label: 'Altura Fonte (H)', unit: 'M', min: 0.5, max: 15, step: 0.1 },
                    { id: 'spacing', label: 'Espaçamento (D)', unit: 'M', min: 0.5, max: 10, step: 0.1 },
                    { id: 'beam', label: 'Abertura Facho', unit: '°', min: 5, max: 120, step: 1 },
                    { id: 'workPlane', label: 'Plano Trab. (hp)', unit: 'M', min: 0, max: 5, step: 0.05 }
                ]
            };

            const currentParams = state.params[toolId];
            
            if(toolId !== 'query') {
                config[toolId].forEach(inp => {
                    const div = document.createElement('div');
                    div.className = "group";
                    div.innerHTML = `
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-[10px] text-muted-blue font-bold uppercase tracking-tighter">${inp.label}</label>
                            <div class="flex items-baseline gap-1">
                                <input type="number" id="${inp.id}-val" value="${currentParams[inp.id]}" step="${inp.step}" class="w-16 text-right bg-transparent text-white border-b border-white/10 focus:border-luminous-gold outline-none text-xs font-mono">
                                <span class="text-[9px] text-muted-blue">${inp.unit}</span>
                            </div>
                        </div>
                        <input type="range" id="${inp.id}-range" min="${inp.min}" max="${inp.max}" step="${inp.step}" value="${currentParams[inp.id]}" class="w-full">
                    `;
                    container.appendChild(div);

                    // Binding dos eventos
                    const numInput = div.querySelector('input[type="number"]');
                    const rangeInput = div.querySelector('input[type="range"]');

                    const update = (val) => {
                        currentParams[inp.id] = parseFloat(val);
                        numInput.value = val;
                        rangeInput.value = val;
                        updateCalculations();
                    };

                    numInput.oninput = (e) => update(e.target.value);
                    rangeInput.oninput = (e) => update(e.target.value);
                });
            }

            // Tabs UI
            ['query', 'ponto', 'vertical', 'homog'].forEach(id => {
                const btn = document.getElementById('tab-' + id);
                if(btn) btn.className = "mode-tab-btn text-[12px] font-bold tracking-widest uppercase transition-all whitespace-nowrap " + (id === toolId ? "tab-active" : "tab-inactive");
            });

            updateCalculations();
        }

        // --- MOTOR DE CÁLCULO E GRÁFICO ---
        function updateCalculations() {
            const canvas = document.getElementById('beamCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d'), cw = canvas.width = canvas.clientWidth, ch = canvas.height = canvas.clientHeight;
            const floorY = ch - 70, centerX = cw / 2;

            ctx.clearRect(0, 0, cw, ch);
            
            // Desenha elementos comuns
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, floorY); ctx.lineTo(cw, floorY); ctx.stroke();

            const p = state.params[state.currentTool];
            if (!p) return;

            const scale = (floorY - 60) / Math.max(p.height, 2);
            const sy = floorY - (p.height * scale);
            const tr = (p.tilt || 0) * Math.PI / 180;
            const br = (p.beam || 30) * Math.PI / 180;

            // Simulação de Facho
            ctx.save();
            ctx.translate(centerX, sy);
            const g = ctx.createLinearGradient(0, 0, 0, floorY - sy);
            g.addColorStop(0, 'rgba(251, 191, 36, 0.6)');
            g.addColorStop(1, 'rgba(251, 191, 36, 0)');
            ctx.fillStyle = g;
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.lineTo((floorY-sy)*Math.tan(tr - br/2), floorY-sy);
            ctx.lineTo((floorY-sy)*Math.tan(tr + br/2), floorY-sy);
            ctx.fill();
            ctx.restore();

            // Fonte
            ctx.fillStyle = '#FBBF24'; ctx.beginPath(); ctx.arc(centerX, sy, 5, 0, Math.PI*2); ctx.fill();

            // Cota de Ângulo
            const radius = 60;
            ctx.beginPath();
            ctx.arc(centerX, sy, radius, Math.PI/2 - tr - br/2, Math.PI/2 - tr + br/2);
            ctx.strokeStyle = '#FBBF24';
            ctx.setLineDash([]);
            ctx.stroke();

            // Textos Técnicos
            ctx.font = "bold 11px Manrope"; ctx.fillStyle = "#cbd5e1"; ctx.textAlign = "center";
            ctx.fillText(p.intensity + " cd (Imax)", centerX, sy - 15);
            ctx.fillText(p.beam + "° (Facho)", centerX, sy + radius + 15);
            
            // Cota de Orientação (Tilt)
            if(p.tilt > 0) {
                ctx.beginPath();
                ctx.arc(centerX, sy, radius + 20, Math.PI/2 - tr, Math.PI/2);
                ctx.strokeStyle = "#22d3ee";
                ctx.stroke();
                ctx.fillStyle = "#22d3ee";
                ctx.fillText(p.tilt + "° Tilt", centerX + (radius+35)*Math.sin(tr/2), sy + (radius+35)*Math.cos(tr/2));
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            switchTool('ponto');
            window.addEventListener('resize', updateCalculations);
        });

        function updateCalcMode(mode) { state.calcMode = mode; updateCalculations(); }
        function handleLogout() { alert("Logout realizado."); }
        function toggleLanguage() { alert("Tradução em desenvolvimento."); }

    </script>
</body>
</html>