<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxSintax | Lighting Design SaaS (v1.2 Stable)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'midnight': '#020617', 
                        'twilight': '#0f172a', 
                        'glass': 'rgba(15, 23, 42, 0.8)',
                        'luminous-gold': '#FBBF24', 
                        'tech-cyan': '#22d3ee', 
                        'dim-gray': '#94a3b8',
                        'dim-line': '#334155',
                        'leed-green': '#84cc16'
                    },
                    fontFamily: { 
                        sans: ['Manrope', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Base & Reset --- */
        body { background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        
        /* Glassmorphism & UI Components */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        /* Inputs Customizados */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 24px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #FBBF24; margin-top: -6px; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); border: 2px solid #0f172a; transition: transform 0.1s; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); }

        input[type=number], select, input[type=text], input[type=email], input[type=password] { 
            background: transparent; color: #f8fafc; border: none; border-bottom: 1px solid #334155; 
            font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; padding: 4px 0; transition: all 0.3s;
        }
        input:focus { outline: none; border-bottom-color: #FBBF24; }
        
        /* Canvas Container */
        .canvas-wrapper {
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        }

        /* Utilities */
        .app-locked { filter: blur(10px); pointer-events: none; user-select: none; overflow: hidden; height: 100vh; }
        .text-xxs { font-size: 0.65rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #FBBF24; }

        /* Tabs */
        .tab-btn { position: relative; transition: all 0.3s; }
        .tab-btn.active { color: #FBBF24; border-color: #FBBF24; background: rgba(251, 191, 36, 0.05); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #FBBF24; box-shadow: 0 0 10px #FBBF24; }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 transition-all duration-700">
        <div class="absolute inset-0 bg-midnight/90 backdrop-blur-md"></div>
        
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl relative z-10 border-t border-luminous-gold/20 shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold tracking-[0.2em] text-luminous-gold mb-2">LUX<span class="text-white font-light opacity-60">SINTAX</span></h1>
                <p class="text-xs text-dim-gray uppercase tracking-widest font-mono">Lighting Intelligence SaaS</p>
                <div id="auth-status" class="mt-4 text-[10px] font-mono text-tech-cyan animate-pulse">ESTABELECENDO CONEXÃO SEGURA...</div>
            </div>

            <div class="flex mb-6 border-b border-white/10">
                <button onclick="AuthManager.setMode('login')" id="btn-mode-login" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-luminous-gold border-b-2 border-luminous-gold">Login</button>
                <button onclick="AuthManager.setMode('register')" id="btn-mode-register" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-dim-gray hover:text-white transition-colors">Cadastro</button>
            </div>

            <div id="form-login" class="space-y-5">
                <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">E-mail</label><input type="email" id="login-email" placeholder="pro@lighting.com"></div>
                <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">Senha</label><input type="password" id="login-password" placeholder="••••••••"></div>
                <button onclick="AuthManager.login()" class="w-full py-4 bg-luminous-gold text-midnight font-bold rounded shadow-lg shadow-luminous-gold/20 hover:bg-white transition-all uppercase tracking-widest text-xs mt-4">Entrar na Plataforma</button>
            </div>

            <div id="form-register" class="space-y-5 hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">Nome</label><input type="text" id="reg-name"></div>
                    <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">Sobrenome</label><input type="text" id="reg-surname"></div>
                </div>
                <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">E-mail</label><input type="email" id="reg-email"></div>
                <div><label class="text-[10px] font-bold text-luminous-gold uppercase block mb-1">Senha</label><input type="password" id="reg-password"></div>
                <button onclick="AuthManager.register()" class="w-full py-4 border border-luminous-gold text-luminous-gold font-bold rounded hover:bg-luminous-gold hover:text-midnight transition-all uppercase tracking-widest text-xs mt-4">Criar Conta</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="app-locked transition-all duration-1000 flex flex-col min-h-screen">
        
        <nav class="sticky top-0 z-40 bg-midnight/80 backdrop-blur-xl border-b border-white/5">
            <div class="max-w-[1920px] mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-lg font-bold tracking-[0.15em] text-luminous-gold">LUX<span class="text-white opacity-50">SINTAX</span></div>
                    <div class="h-4 w-[1px] bg-white/20"></div>
                    <div class="flex gap-6 text-xs font-bold tracking-widest text-dim-gray">
                        <button onclick="App.setView('calc')" class="hover:text-white transition-colors text-white">CALCULADORA</button>
                        <button onclick="App.setView('about')" class="hover:text-white transition-colors">SOBRE</button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div id="user-name" class="text-[10px] font-bold text-white uppercase">USUÁRIO</div>
                        <div class="text-[9px] text-leed-green font-mono">PRO LICENSE</div>
                    </div>
                    <button onclick="AuthManager.logout()" class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-dim-gray hover:text-red-400 hover:bg-white/10 transition-all"><i class="fas fa-power-off text-xs"></i></button>
                </div>
            </div>
        </nav>

        <main class="flex-grow relative">
            
            <section id="view-calc" class="p-6 max-w-[1920px] mx-auto h-full flex flex-col">
                
                <div class="flex overflow-x-auto gap-4 mb-6 pb-2 border-b border-white/5">
                    <button onclick="App.setTool('query')" id="tab-query" class="tab-btn active px-6 py-3 flex items-center gap-3 min-w-max">
                        <i class="fas fa-search text-lg"></i>
                        <div class="text-left"><div class="text-[10px] font-bold uppercase text-dim-gray">Biblioteca</div><div class="text-xs font-bold">NORMAS & LEED</div></div>
                    </button>
                    <button onclick="App.setTool('ponto')" id="tab-ponto" class="tab-btn px-6 py-3 flex items-center gap-3 min-w-max">
                        <i class="fas fa-bullseye text-lg"></i>
                        <div class="text-left"><div class="text-[10px] font-bold uppercase text-dim-gray">Cálculo</div><div class="text-xs font-bold">PONTO A PONTO</div></div>
                    </button>
                    <button onclick="App.setTool('vertical')" id="tab-vertical" class="tab-btn px-6 py-3 flex items-center gap-3 min-w-max">
                        <i class="fas fa-arrows-alt-v text-lg"></i>
                        <div class="text-left"><div class="text-[10px] font-bold uppercase text-dim-gray">Cálculo</div><div class="text-xs font-bold">VERTICAL / WALL</div></div>
                    </button>
                    <button onclick="App.setTool('homog')" id="tab-homog" class="tab-btn px-6 py-3 flex items-center gap-3 min-w-max">
                        <i class="fas fa-th text-lg"></i>
                        <div class="text-left"><div class="text-[10px] font-bold uppercase text-dim-gray">Análise</div><div class="text-xs font-bold">DISTRIBUIÇÃO</div></div>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full min-h-[600px]">
                    
                    <div class="lg:col-span-3 flex flex-col gap-4">
                        
                        <div id="controls-panel" class="glass-panel p-5 rounded-xl hidden">
                            <h3 class="text-xs font-bold text-luminous-gold uppercase tracking-widest mb-4 border-b border-white/10 pb-2">Parâmetros de Entrada</h3>
                            
                            <div class="flex bg-black/40 rounded p-1 mb-6">
                                <button onclick="App.setCalcMode('direct')" id="mode-direct" class="flex-1 py-1 text-[9px] font-bold uppercase rounded bg-white/10 text-white">Intensidade (cd)</button>
                                <button onclick="App.setCalcMode('photo')" id="mode-photo" class="flex-1 py-1 text-[9px] font-bold uppercase text-dim-gray hover:text-white">Fotometria</button>
                            </div>

                            <div id="dynamic-inputs" class="space-y-5">
                                </div>
                        </div>

                        <div id="query-menu" class="glass-panel p-5 rounded-xl">
                            <h3 class="text-xs font-bold text-luminous-gold uppercase tracking-widest mb-4 border-b border-white/10 pb-2">Base de Dados</h3>
                            <div class="space-y-2">
                                <button onclick="QuerySystem.load('nbr8995')" class="w-full text-left px-4 py-3 rounded bg-white/5 hover:bg-white/10 hover:border-luminous-gold border border-transparent transition-all text-xs font-bold uppercase flex justify-between"><span>NBR 8995-1</span> <i class="fas fa-chevron-right text-[10px] mt-1"></i></button>
                                <button onclick="QuerySystem.load('leed')" class="w-full text-left px-4 py-3 rounded bg-white/5 hover:bg-white/10 hover:border-luminous-gold border border-transparent transition-all text-xs font-bold uppercase flex justify-between"><span>LEED v4.1 / WELL</span> <i class="fas fa-chevron-right text-[10px] mt-1"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-9 flex flex-col">
                        <div class="glass-panel p-1 rounded-xl flex-grow h-full relative overflow-hidden flex flex-col">
                            
                            <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-midnight/30">
                                <h2 id="result-title" class="text-sm font-bold text-white uppercase tracking-wider"><i class="fas fa-chart-pie mr-2 text-luminous-gold"></i> Visualização Gráfica</h2>
                                <div id="calc-readout" class="flex gap-4 opacity-0 transition-opacity duration-300">
                                    <div class="text-right"><div class="text-[9px] text-dim-gray uppercase">Iluminância (Piso)</div><div class="text-lg font-mono font-bold text-luminous-gold leading-none"><span id="val-lux-floor">0</span> <span class="text-xs">lx</span></div></div>
                                    <div class="text-right pl-4 border-l border-white/10"><div class="text-[9px] text-dim-gray uppercase">Diâmetro (Ø)</div><div class="text-lg font-mono font-bold text-tech-cyan leading-none"><span id="val-dia">0.0</span> <span class="text-xs">m</span></div></div>
                                </div>
                            </div>

                            <div class="relative flex-grow bg-twilight/50 canvas-wrapper">
                                
                                <canvas id="mainCanvas" class="absolute inset-0 w-full h-full z-10 hidden"></canvas>
                                
                                <div id="query-content" class="absolute inset-0 w-full h-full z-20 overflow-auto p-6 custom-scrollbar">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // --- Configuration ---
        const SUPABASE_URL = 'https://ozytwdhuxsdefnunzinm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96eXR3ZGh1eHNkZWZudW56aW5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjM2MjEsImV4cCI6MjA4NjIzOTYyMX0.G6d564WnaaUQVSjTjpCDEA4d6zaVMvB_NQpo1KtE24s';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- State Management ---
        const State = {
            tool: 'query',
            calcMode: 'direct',
            params: {
                ponto: { intensity: 3000, height: 3.0, beam: 36, tilt: 0, workPlane: 0.75, flux: 2000, cdklm: 1500 },
                vertical: { intensity: 3000, height: 3.0, dist: 1.0, tilt: 30, beam: 24, flux: 2000, cdklm: 1500, hq: 1.6 },
                homog: { intensity: 3000, height: 3.0, spacing: 2.5, workPlane: 0.75, beam: 60, flux: 2000, cdklm: 1500 }
            }
        };

        // --- Norms Data ---
        const Norms = [
            { cat: "Escritório", room: "Escrita / Digitação", lux: 500, ugr: 19 },
            { cat: "Escritório", room: "Reunião", lux: 500, ugr: 19 },
            { cat: "Escritório", room: "Arquivamento", lux: 300, ugr: 25 },
            { cat: "Industrial", room: "Usinagem Fina", lux: 750, ugr: 19 },
            { cat: "Industrial", room: "Depósito", lux: 100, ugr: 25 },
            { cat: "Varejo", room: "Área de Vendas", lux: 300, ugr: 22 },
            { cat: "Varejo", room: "Vitrine", lux: 1000, ugr: "-" },
            { cat: "Educação", room: "Sala de Aula", lux: 300, ugr: 19 },
            { cat: "Hospitalar", room: "Centro Cirúrgico", lux: 1000, ugr: 19 },
            { cat: "Hospitalar", room: "Quarto", lux: 100, ugr: 19 }
        ];

        // --- Authentication Logic ---
        window.AuthManager = {
            init: async () => {
                const { data } = await supabase.auth.getSession();
                if (data.session) AuthManager.unlock(data.session);
                else document.getElementById('auth-status').innerText = "AGUARDANDO CREDENCIAIS";
                
                supabase.auth.onAuthStateChange((_evt, session) => {
                    if (session) AuthManager.unlock(session);
                    else window.location.reload();
                });
            },
            setMode: (mode) => {
                document.getElementById('form-login').classList.toggle('hidden', mode !== 'login');
                document.getElementById('form-register').classList.toggle('hidden', mode !== 'register');
                document.getElementById('btn-mode-login').className = mode === 'login' ? "flex-1 py-3 text-xs font-bold uppercase tracking-wider text-luminous-gold border-b-2 border-luminous-gold" : "flex-1 py-3 text-xs font-bold uppercase tracking-wider text-dim-gray hover:text-white transition-colors";
                document.getElementById('btn-mode-register').className = mode === 'register' ? "flex-1 py-3 text-xs font-bold uppercase tracking-wider text-luminous-gold border-b-2 border-luminous-gold" : "flex-1 py-3 text-xs font-bold uppercase tracking-wider text-dim-gray hover:text-white transition-colors";
            },
            login: async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert("Erro: " + error.message);
            },
            register: async () => {
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) alert(error.message); else alert("Verifique seu e-mail!");
            },
            unlock: (session) => {
                document.getElementById('auth-overlay').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('app-container').classList.remove('app-locked');
                const user = session.user.email.split('@')[0];
                document.getElementById('user-name').innerText = user;
                App.init();
            },
            logout: async () => supabase.auth.signOut()
        };

        // --- UI & Application Logic ---
        window.App = {
            init: () => {
                App.setTool('query');
                QuerySystem.load('nbr8995');
                window.addEventListener('resize', () => RenderEngine.draw());
            },
            setTool: (tool) => {
                State.tool = tool;
                // Update Tabs UI
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'border-luminous-gold'));
                document.getElementById(`tab-${tool}`).classList.add('active');

                // Toggle View Panels
                const isQuery = tool === 'query';
                document.getElementById('controls-panel').classList.toggle('hidden', isQuery);
                document.getElementById('query-menu').classList.toggle('hidden', !isQuery);
                document.getElementById('mainCanvas').classList.toggle('hidden', isQuery);
                document.getElementById('query-content').classList.toggle('hidden', !isQuery);
                document.getElementById('calc-readout').classList.toggle('opacity-0', isQuery);

                if (!isQuery) {
                    InputBuilder.build(tool);
                    RenderEngine.draw();
                }
            },
            setCalcMode: (mode) => {
                State.calcMode = mode;
                document.getElementById('mode-direct').className = mode === 'direct' ? "flex-1 py-1 text-[9px] font-bold uppercase rounded bg-white/10 text-white" : "flex-1 py-1 text-[9px] font-bold uppercase text-dim-gray hover:text-white";
                document.getElementById('mode-photo').className = mode === 'photo' ? "flex-1 py-1 text-[9px] font-bold uppercase rounded bg-white/10 text-white" : "flex-1 py-1 text-[9px] font-bold uppercase text-dim-gray hover:text-white";
                InputBuilder.build(State.tool); // Rebuild inputs
                RenderEngine.draw();
            }
        };

        // --- Input Builder (Dynamic Form Generation) ---
        window.InputBuilder = {
            build: (tool) => {
                const container = document.getElementById('dynamic-inputs');
                container.innerHTML = '';

                const config = {
                    ponto: [
                        { id: 'height', label: 'Altura (H)', unit: 'm', min: 1, max: 15, step: 0.1 },
                        { id: 'workPlane', label: 'Plano Trabalho', unit: 'm', min: 0, max: 2, step: 0.05 },
                        { id: 'beam', label: 'Facho', unit: '°', min: 5, max: 120, step: 1 },
                        { id: 'tilt', label: 'Tilt', unit: '°', min: 0, max: 60, step: 1 }
                    ],
                    vertical: [
                        { id: 'height', label: 'Altura (H)', unit: 'm', min: 1, max: 15, step: 0.1 },
                        { id: 'dist', label: 'Dist. Parede', unit: 'm', min: 0.5, max: 5, step: 0.1 },
                        { id: 'hq', label: 'Eixo Quadro', unit: 'm', min: 0.5, max: 5, step: 0.1 },
                        { id: 'tilt', label: 'Tilt', unit: '°', min: 0, max: 60, step: 1 },
                        { id: 'beam', label: 'Facho', unit: '°', min: 5, max: 120, step: 1 }
                    ],
                    homog: [
                        { id: 'height', label: 'Altura (H)', unit: 'm', min: 1, max: 15, step: 0.1 },
                        { id: 'spacing', label: 'Espaçamento', unit: 'm', min: 0.5, max: 8, step: 0.1 },
                        { id: 'beam', label: 'Facho', unit: '°', min: 5, max: 120, step: 1 }
                    ]
                };

                // Add Geometry Inputs
                config[tool].forEach(field => {
                    const val = State.params[tool][field.id];
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <div class="flex justify-between items-end mb-1">
                            <label class="text-[10px] text-dim-gray font-mono uppercase">${field.label}</label>
                            <div class="text-[10px] font-bold text-white"><span id="disp-${field.id}">${val}</span>${field.unit}</div>
                        </div>
                        <input type="range" id="in-${field.id}" min="${field.min}" max="${field.max}" step="${field.step}" value="${val}">
                    `;
                    container.appendChild(div);
                    document.getElementById(`in-${field.id}`).addEventListener('input', (e) => {
                        const v = parseFloat(e.target.value);
                        State.params[tool][field.id] = v;
                        document.getElementById(`disp-${field.id}`).innerText = v;
                        RenderEngine.draw();
                    });
                });

                // Add Intensity Inputs (Based on Mode)
                const intensityDiv = document.createElement('div');
                intensityDiv.className = "pt-4 border-t border-white/5";
                
                if (State.calcMode === 'direct') {
                    intensityDiv.innerHTML = `
                        <div class="flex justify-between items-end mb-1"><label class="text-[10px] text-luminous-gold font-bold uppercase">Intensidade</label><div class="text-[10px] text-white font-mono"><span id="disp-int">${State.params[tool].intensity}</span>cd</div></div>
                        <input type="range" id="in-intensity" min="100" max="20000" step="100" value="${State.params[tool].intensity}">
                    `;
                } else {
                    intensityDiv.innerHTML = `
                        <div class="mb-3"><div class="flex justify-between items-end mb-1"><label class="text-[10px] text-dim-gray uppercase">Fluxo (Lumens)</label><div class="text-[10px] text-white font-mono"><span id="disp-flux">${State.params[tool].flux}</span>lm</div></div><input type="range" id="in-flux" min="100" max="10000" step="100" value="${State.params[tool].flux}"></div>
                        <div><div class="flex justify-between items-end mb-1"><label class="text-[10px] text-dim-gray uppercase">Fotometria (cd/klm)</label><div class="text-[10px] text-white font-mono"><span id="disp-cdklm">${State.params[tool].cdklm}</span></div></div><input type="range" id="in-cdklm" min="100" max="5000" step="50" value="${State.params[tool].cdklm}"></div>
                    `;
                }
                container.appendChild(intensityDiv);
                
                // Bind Intensity Listeners
                if(State.calcMode === 'direct') {
                    document.getElementById('in-intensity').addEventListener('input', (e) => { State.params[tool].intensity = parseInt(e.target.value); document.getElementById('disp-int').innerText = e.target.value; RenderEngine.draw(); });
                } else {
                    document.getElementById('in-flux').addEventListener('input', (e) => { State.params[tool].flux = parseInt(e.target.value); document.getElementById('disp-flux').innerText = e.target.value; RenderEngine.draw(); });
                    document.getElementById('in-cdklm').addEventListener('input', (e) => { State.params[tool].cdklm = parseInt(e.target.value); document.getElementById('disp-cdklm').innerText = e.target.value; RenderEngine.draw(); });
                }
            }
        };

        // --- Render Engine (Canvas) - O CORAÇÃO DO SISTEMA ---
        window.RenderEngine = {
            draw: () => {
                const canvas = document.getElementById('mainCanvas');
                const ctx = canvas.getContext('2d');
                const tool = State.tool;
                if (tool === 'query') return;

                // 1. Setup Canvas DPI
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);

                // 2. Constants & Physics
                const W = rect.width;
                const H = rect.height;
                const floorY = H - 60; // Base floor position
                const CX = W / 2;
                const P = State.params[tool];
                
                // Calculate Scale (Pixels per Meter) - Auto-zoom
                // Height takes 60% of screen height
                let scale = (H * 0.6) / Math.max(P.height, 1);
                // Clamp scale to prevent issues
                scale = Math.max(20, Math.min(scale, 150));

                // 3. Helper Functions (Dimensions/Cotas)
                const drawLine = (x1, y1, x2, y2, style = '#475569', dash = []) => {
                    ctx.beginPath(); ctx.strokeStyle = style; ctx.lineWidth = 1; ctx.setLineDash(dash);
                    ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); ctx.setLineDash([]);
                };

                const drawDim = (x1, y1, x2, y2, text, offset = 20) => {
                    // Lines
                    ctx.beginPath(); ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1;
                    // Ticks
                    const ang = Math.atan2(y2-y1, x2-x1);
                    const pX = Math.cos(ang + Math.PI/2) * 4;
                    const pY = Math.sin(ang + Math.PI/2) * 4;
                    
                    // Main Line
                    ctx.moveTo(x1, y1 + offset); ctx.lineTo(x2, y2 + offset);
                    // End Caps
                    ctx.moveTo(x1, y1 + offset - 3); ctx.lineTo(x1, y1 + offset + 3);
                    ctx.moveTo(x2, y2 + offset - 3); ctx.lineTo(x2, y2 + offset + 3);
                    ctx.stroke();

                    // Text Box
                    ctx.font = "bold 11px JetBrains Mono";
                    const tw = ctx.measureText(text).width;
                    const midX = (x1 + x2) / 2;
                    const midY = (y1 + y2) / 2 + offset;
                    
                    ctx.fillStyle = "rgba(2,6,23,0.9)";
                    ctx.fillRect(midX - tw/2 - 4, midY - 8, tw + 8, 16);
                    
                    ctx.fillStyle = "#FBBF24";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(text, midX, midY);
                };

                const drawSpot = (x, y) => {
                    ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI*2);
                    ctx.fillStyle = '#FBBF24'; ctx.fill();
                    ctx.shadowBlur = 15; ctx.shadowColor = '#FBBF24'; ctx.fill(); ctx.shadowBlur = 0;
                };

                const getLux = (intensity, dist, angleRad) => {
                    return (intensity * Math.cos(angleRad)) / (dist * dist);
                };

                // 4. Render Scene
                ctx.clearRect(0, 0, W, H);

                // Draw Floor
                drawLine(0, floorY, W, floorY, '#cbd5e1');
                ctx.fillStyle = '#64748b'; ctx.font = "10px Manrope"; ctx.textAlign="left"; ctx.fillText("FLOOR (0.00m)", 10, floorY - 5);

                const srcY = floorY - (P.height * scale);
                const intensity = State.calcMode === 'direct' ? P.intensity : (P.flux * P.cdklm / 1000);
                
                // --- TOOL SPECIFIC LOGIC ---
                if (tool === 'ponto') {
                    const tr = P.tilt * Math.PI / 180;
                    const br = P.beam * Math.PI / 180;
                    
                    // Draw Beam
                    const hBeam = floorY - srcY;
                    const xL = CX + Math.tan(tr - br/2) * hBeam;
                    const xR = CX + Math.tan(tr + br/2) * hBeam;
                    
                    const grad = ctx.createLinearGradient(CX, srcY, CX, floorY);
                    grad.addColorStop(0, `rgba(251, 191, 36, 0.4)`);
                    grad.addColorStop(1, `rgba(251, 191, 36, 0.0)`);
                    
                    ctx.beginPath(); ctx.moveTo(CX, srcY); ctx.lineTo(xL, floorY); ctx.lineTo(xR, floorY); ctx.closePath();
                    ctx.fillStyle = grad; ctx.fill();

                    // Draw Source
                    drawSpot(CX, srcY);

                    // Draw Height Dimension
                    drawDim(CX - 50, floorY, CX - 50, srcY, `H: ${P.height}m`, 0);

                    // Draw Diameter on Floor
                    const dia = Math.abs(xR - xL) / scale;
                    drawDim(xL, floorY, xR, floorY, `Ø ${dia.toFixed(2)}m`, 20);

                    // Calculations
                    const distToFloor = P.height / Math.cos(tr);
                    const luxVal = (intensity * Math.pow(Math.cos(tr), 3)) / (P.height * P.height);
                    
                    // Update UI Readout
                    document.getElementById('val-lux-floor').innerText = Math.round(luxVal);
                    document.getElementById('val-dia').innerText = dia.toFixed(2);

                } 
                else if (tool === 'vertical') {
                    const wallX = CX + (P.dist * scale);
                    const tr = P.tilt * Math.PI / 180;
                    
                    // Wall Line
                    drawLine(wallX, floorY, wallX, srcY - 50, '#94a3b8', []);
                    ctx.fillStyle = '#94a3b8'; ctx.fillText("WALL", wallX + 5, floorY - 5);

                    // Source
                    drawSpot(CX, srcY);
                    
                    // Aim Axis
                    const hitY = srcY + Math.tan(tr) * (P.dist * scale);
                    // Prevent drawing to infinity
                    if(hitY < floorY + 1000 && hitY > -1000) {
                         drawLine(CX, srcY, wallX, hitY, '#FBBF24', [5,5]);
                         // Intersection Dot
                         if (hitY < floorY) {
                            ctx.beginPath(); ctx.arc(wallX, hitY, 4, 0, Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
                            const luxV = (intensity * Math.pow(Math.cos(tr), 3)) / (P.dist * P.dist); // Simplified normal incidence approximation
                            ctx.fillText(`${Math.round(luxV)} lx`, wallX + 10, hitY);
                         }
                    }

                    // Beam Cone
                    const br = P.beam * Math.PI / 180;
                    ctx.save();
                    ctx.beginPath(); ctx.rect(0,0, wallX, H); ctx.clip(); // Clip to wall
                    const grad = ctx.createLinearGradient(CX, srcY, wallX, srcY);
                    grad.addColorStop(0, `rgba(251, 191, 36, 0.4)`); grad.addColorStop(1, `rgba(251, 191, 36, 0)`);
                    ctx.fillStyle = grad;
                    ctx.beginPath(); ctx.moveTo(CX, srcY);
                    ctx.lineTo(wallX, srcY + Math.tan(tr - br/2) * (P.dist*scale));
                    ctx.lineTo(wallX, srcY + Math.tan(tr + br/2) * (P.dist*scale));
                    ctx.fill();
                    ctx.restore();

                    // Dimensions
                    drawDim(CX, srcY, wallX, srcY, `D: ${P.dist}m`, -20);
                    drawDim(CX - 20, floorY, CX - 20, srcY, `H: ${P.height}m`, 0);

                    document.getElementById('val-lux-floor').innerText = "-"; // N/A for wall mode usually
                    document.getElementById('val-dia').innerText = "-";
                }
                else if (tool === 'homog') {
                    const hSpacing = (P.spacing * scale) / 2;
                    const lX = CX - hSpacing;
                    const rX = CX + hSpacing;

                    drawSpot(lX, srcY);
                    drawSpot(rX, srcY);

                    // Beams
                    const br = P.beam * Math.PI / 180;
                    const hBeam = floorY - srcY;
                    const wBeam = Math.tan(br/2) * hBeam;

                    [lX, rX].forEach(x => {
                        const grad = ctx.createLinearGradient(x, srcY, x, floorY);
                        grad.addColorStop(0, `rgba(251, 191, 36, 0.3)`); grad.addColorStop(1, `rgba(251, 191, 36, 0)`);
                        ctx.beginPath(); ctx.moveTo(x, srcY);
                        ctx.lineTo(x - wBeam, floorY); ctx.lineTo(x + wBeam, floorY);
                        ctx.fillStyle = grad; ctx.fill();
                    });

                    // Overlap
                    const overlapStart = rX - wBeam;
                    const overlapEnd = lX + wBeam;
                    if (overlapEnd > overlapStart) {
                        ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
                        ctx.fillRect(overlapStart, floorY - 10, overlapEnd - overlapStart, 10);
                    }

                    // Dimensions
                    drawDim(lX, srcY, rX, srcY, `Spacing: ${P.spacing}m`, -20);
                    drawDim(lX - 40, floorY, lX - 40, srcY, `H: ${P.height}m`, 0);

                    // Lux at center (approx superposition)
                    const luxCenter = 2 * (intensity * Math.pow(Math.cos(Math.atan((P.spacing/2)/P.height)), 3)) / (P.height**2 + (P.spacing/2)**2);
                    document.getElementById('val-lux-floor').innerText = Math.round(luxCenter);
                    document.getElementById('val-dia').innerText = "-";
                }
            }
        };

        // --- Query System ---
        window.QuerySystem = {
            load: (db) => {
                const container = document.getElementById('query-content');
                container.innerHTML = '';
                
                if (db === 'nbr8995') {
                    let html = `<table class="w-full text-left border-collapse"><thead class="bg-white/5 sticky top-0 backdrop-blur-md"><tr><th class="p-3 text-xs text-dim-gray uppercase">Categoria</th><th class="p-3 text-xs text-dim-gray uppercase">Ambiente</th><th class="p-3 text-xs text-white uppercase text-center">Lux</th><th class="p-3 text-xs text-dim-gray uppercase text-center">UGR</th></tr></thead><tbody>`;
                    Norms.forEach(n => {
                        html += `<tr class="border-b border-white/5 hover:bg-white/5"><td class="p-3 text-xs text-luminous-gold font-bold">${n.cat}</td><td class="p-3 text-xs text-white">${n.room}</td><td class="p-3 text-xs text-white font-mono font-bold text-center bg-white/5">${n.lux}</td><td class="p-3 text-xs text-dim-gray text-center">${n.ugr}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } 
                else if (db === 'leed') {
                    container.innerHTML = `
                        <div class="space-y-4">
                            <div class="p-4 bg-white/5 rounded border border-leed-green/30">
                                <h4 class="text-leed-green font-bold text-sm mb-2">LEED v4.1 - Interior Lighting</h4>
                                <p class="text-xs text-dim-gray mb-2">Opção 1: Controle de Iluminação</p>
                                <ul class="list-disc pl-4 text-xs text-white space-y-1">
                                    <li>Controle individual para 90% dos ocupantes.</li>
                                    <li>Controle multi-nível (3+ cenas) em áreas de conferência.</li>
                                </ul>
                            </div>
                            <div class="p-4 bg-white/5 rounded border border-tech-cyan/30">
                                <h4 class="text-tech-cyan font-bold text-sm mb-2">WELL v2 - L02 Visual Balance</h4>
                                <p class="text-xs text-dim-gray mb-2">Gestão de Luminância</p>
                                <ul class="list-disc pl-4 text-xs text-white space-y-1">
                                    <li>Max ratio 10:1 (Principal vs Auxiliar).</li>
                                    <li>Mudanças graduais de luz (transição espacial).</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
            }
        };

        // --- Init ---
        AuthManager.init();

    </script>
</body>
</html>